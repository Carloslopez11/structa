<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Payment Success - Structa</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<style>
/* TUS ESTILOS OSCUROS */
body {
    background: #0f0f16;
    color: white;
    font-family: 'Segoe UI', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    margin: 0;
    text-align: center;
}

.card {
    background: #1a1a2e;
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 0 40px rgba(124, 58, 237, 0.3);
    max-width: 90%;
    width: 400px;
    border: 1px solid #333;
}

h1 { color: white; margin-bottom: 5px; }
h1 span { color: #7c3aed; }
p { color: #aaa; margin-bottom: 30px; }

/* Botón manual por si acaso */
.btn-download {
    background: linear-gradient(135deg, #7c3aed, #5b21b6);
    color: white;
    border: none;
    padding: 15px 30px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 10px;
    cursor: pointer;
    width: 100%;
    margin-top: 10px;
    display: none; /* Se oculta si descarga automático */
}
</style>
</head>

<body>

    <div class="card">
        <div style="font-size: 60px; margin-bottom: 20px;">✅</div>
        <h1>Payment <span>Successful</span></h1>
        <p id="statusMsg">Generando tu factura PDF...</p>
        
        <button id="manualBtn" class="btn-download" onclick="generateInvoicePDF()">
            Descargar Factura PDF
        </button>

        <a href="app.html" style="color:#666; font-size:12px; text-decoration:none; margin-top:20px; display:block;">
            Volver al inicio
        </a>
    </div>

<script>
    const { jsPDF } = window.jspdf;

    // AL CARGAR LA PÁGINA (Regreso de Stripe)
    window.onload = function() {
        // Esperamos 1 segundo para que el usuario vea el check verde y luego descargamos
        setTimeout(() => {
            generateInvoicePDF();
        }, 1500);
    };

    function generateInvoicePDF() {
        // 1. RECUPERAR DATOS (Guardados antes de ir a Stripe)
        const rawData = localStorage.getItem("structa_data");
        
        if (!rawData) {
            document.getElementById("statusMsg").textContent = "No se encontraron datos de la factura.";
            return;
        }

        const data = JSON.parse(rawData);
        const doc = new jsPDF();

        // --- DISEÑO DE FACTURA ---
        const purple = [124, 58, 237];

        // 1. Franja Superior
        doc.setFillColor(...purple);
        doc.rect(0, 0, 210, 15, 'F');

        // 2. Título "INVOICE"
        doc.setFont("helvetica", "bold");
        doc.setFontSize(22);
        doc.setTextColor(...purple);
        doc.text("INVOICE", 195, 35, { align: "right" });

        // 3. Logo (Si el cliente subió uno)
        if (data.logo) {
            try { doc.addImage(data.logo, 'JPEG', 15, 25, 30, 30); } catch (e) {}
        }

        // 4. Datos del Cliente y Empresa
        doc.setFontSize(10);
        doc.setTextColor(0);
        
        // Emisor (Tú)
        doc.setFont("helvetica", "bold");
        doc.text("DE:", 15, 70);
        doc.setFont("helvetica", "normal");
        doc.text(data.company || "Structa Inc", 15, 76);

        // Cliente (El que pagó)
        doc.setFont("helvetica", "bold");
        doc.text("PARA:", 110, 70);
        doc.setFont("helvetica", "normal");
        doc.text(data.client || "Cliente", 110, 76);

        // 5. Tabla de Detalles
        doc.autoTable({
            startY: 90,
            head: [['Descripción', 'Metros (m²)', 'Precio Unit.', 'Total']],
            body: [
                [
                    data.work, 
                    data.area + " m²", 
                    "$" + data.price, 
                    "$" + data.total
                ]
            ],
            theme: 'grid',
            headStyles: { fillColor: purple, textColor: 255, fontStyle: 'bold' },
            styles: { fontSize: 11, cellPadding: 6 },
            columnStyles: { 3: { halign: 'right', fontStyle: 'bold' } }
        });

        // 6. TOTAL FINAL (Lo más importante)
        const finalY = doc.lastAutoTable.finalY + 10;
        
        // Caja gris para el total
        doc.setFillColor(245, 245, 245);
        doc.rect(120, finalY, 75, 20, 'F');

        doc.setFontSize(14);
        doc.setTextColor(...purple);
        doc.setFont("helvetica", "bold");
        doc.text(`TOTAL PAGADO: $${data.total}`, 190, finalY + 13, { align: "right" });

        // 7. Pie de página
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text("Gracias por su pago - Generado por Structa", 105, 280, { align: "center" });

        // --- DESCARGAR ---
        doc.save(`Factura_${data.client}.pdf`);
        
        // Actualizar mensaje en pantalla
        document.getElementById("statusMsg").textContent = "Factura descargada exitosamente.";
        document.getElementById("manualBtn").style.display = "block"; // Mostrar botón por si quieren bajarla otra vez
    }
</script>

</body>
</html>
